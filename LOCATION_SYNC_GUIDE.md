# Синхронизация геолокации между веб-приложением и Telegram ботом

## Обзор

Реализована система синхронизации геолокации, которая позволяет пользователям делиться своим местоположением через **веб-приложение**, а не через Telegram чат (где эта функция не всегда работает).

---

## Как это работает

### Схема работы:

```
┌─────────────────┐
│  Веб-приложение │
│  (Qibla/Prayer) │
└────────┬────────┘
         │ 1. Пользователь нажимает "Разрешить доступ"
         │    к геолокации
         ▼
┌─────────────────────────────────┐
│  navigator.geolocation          │
│  getCurrentPosition()           │
└────────┬────────────────────────┘
         │ 2. Получены координаты
         │    (latitude, longitude)
         ▼
┌─────────────────────────────────┐
│  POST /api/location             │
│  {                              │
│    telegramId,                  │
│    latitude,                    │
│    longitude,                   │
│    city?, country?              │
│  }                              │
└────────┬────────────────────────┘
         │ 3. Сохранение в MongoDB
         ▼
┌─────────────────────────────────┐
│  MongoDB - User Collection      │
│  prayerSettings.location {      │
│    latitude: 59.9009,           │
│    longitude: 30.2922,          │
│    timezone: "Europe/Moscow",   │
│    city: "Saint Petersburg",    │
│    country: "Russia",           │
│    updatedAt: Date              │
│  }                              │
└────────┬────────────────────────┘
         │ 4. Бот читает из MongoDB
         ▼
┌─────────────────────────────────┐
│  Telegram Bot                   │
│  - Рассчитывает время молитв    │
│  - Отправляет уведомления       │
│  - Показывает в /prayer команде │
└─────────────────────────────────┘
```

---

## Использование для пользователя

### Шаг 1: Открыть веб-приложение

1. Запустить Telegram бот: **@MubarakWayBot**
2. Нажать кнопку **"🌐 Открыть приложение"** или использовать команду `/start`
3. В веб-приложении перейти на страницу:
   - **📿 Время намаза** (Prayer Times), или
   - **🧭 Кибла** (Qibla)

### Шаг 2: Поделиться геолокацией

На странице с временем молитв или киблой появится запрос:

```
┌──────────────────────────────────────┐
│          📍 Геолокация               │
├──────────────────────────────────────┤
│  Для точного расчета времени молитв  │
│  нам нужна ваша геолокация.          │
│                                      │
│  Мы используем её только для         │
│  определения времени намаза.         │
│  Данные не передаются третьим лицам. │
│                                      │
│  [📍 Разрешить доступ]               │
└──────────────────────────────────────┘
```

1. Нажать **"📍 Разрешить доступ"**
2. Браузер запросит разрешение
3. Нажать **"Разрешить"**

### Шаг 3: Проверка в Telegram боте

После сохранения локации в веб-приложении, она автоматически доступна в боте:

1. Открыть чат с ботом
2. Отправить команду `/prayer`
3. Бот покажет время молитв для вашей локации:

```
📍 Координаты: 59.9009, 30.2922
🌍 Часовой пояс: Europe/Moscow

⏰ Время молитв на сегодня:

🌅 Фаджр: 05:36
🌄 Восход: 07:56
☀️ Зухр: 12:44
🌤️ Аср: 14:51
🌆 Магриб: 17:30
🌙 Иша: 19:41

📿 Следующая молитва: Зухр в 12:44
```

---

## Технические детали

### API Endpoint

**POST /api/location**

Сохраняет геолокацию пользователя в базу данных.

**Request Body:**
```json
{
  "telegramId": "123456789",
  "latitude": 59.9009,
  "longitude": 30.2922,
  "city": "Saint Petersburg",
  "country": "Russia"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Location updated successfully",
  "data": {
    "location": {
      "latitude": 59.9009,
      "longitude": 30.2922,
      "city": "Saint Petersburg",
      "country": "Russia",
      "timezone": "Europe/Moscow"
    }
  }
}
```

**GET /api/location/:telegramId**

Получает сохраненную геолокацию пользователя.

**Response:**
```json
{
  "success": true,
  "data": {
    "location": {
      "latitude": 59.9009,
      "longitude": 30.2922,
      "city": "Saint Petersburg",
      "country": "Russia",
      "timezone": "Europe/Moscow",
      "updatedAt": "2025-01-31T12:30:00.000Z"
    }
  }
}
```

---

## Автоматическое определение часового пояса

Система автоматически определяет часовой пояс на основе координат:

### Поддерживаемые регионы:

| Регион | Timezone | Координаты |
|--------|----------|------------|
| Москва, Санкт-Петербург | Europe/Moscow | 41-82° N, 19-180° E |
| Калининград | Europe/Kaliningrad | 54-56° N, 19-23° E |
| Самара | Europe/Samara | 50-56° N, 45-55° E |
| Екатеринбург | Asia/Yekaterinburg | 54-62° N, 55-65° E |
| Омск | Asia/Omsk | 53-60° N, 68-78° E |
| Красноярск | Asia/Krasnoyarsk | 51-72° N, 84-106° E |
| Иркутск | Asia/Irkutsk | 50-62° N, 100-120° E |
| Якутск | Asia/Yakutsk | 55-75° N, 115-148° E |
| Владивосток | Asia/Vladivostok | 42-70° N, 130-150° E |
| Ташкент | Asia/Tashkent | 37-46° N, 55-74° E |
| Алматы | Asia/Almaty | 40-56° N, 46-88° E |
| Стамбул | Europe/Istanbul | 36-42° N, 25-45° E |
| Дубай | Asia/Dubai | 22-27° N, 51-57° E |
| Эр-Рияд | Asia/Riyadh | 16-33° N, 34-56° E |

Если регион не найден, используется автоматический расчет по долготе:
```
Timezone offset = round(longitude / 15)
```

---

## Модель данных (MongoDB)

### User Schema - prayerSettings.location

```javascript
prayerSettings: {
  location: {
    latitude: Number,        // Широта
    longitude: Number,       // Долгота
    city: String,           // Город (опционально)
    country: String,        // Страна (опционально)
    timezone: {             // Часовой пояс
      type: String,
      default: 'Europe/Moscow'
    },
    updatedAt: {            // Время последнего обновления
      type: Date,
      default: Date.now
    }
  },
  calculationMethod: {
    type: String,
    default: 'MuslimWorldLeague'
  },
  notifications: {
    enabled: Boolean,
    // ...
  }
}
```

---

## Файлы проекта

### Backend

1. **server/routes/location.js** - Новый API endpoint для локации
2. **server/models/User.js** - Обновленная модель с полями timezone и updatedAt
3. **server/server.js** - Подключение location routes
4. **server/bot.js** - Обновлен для чтения из MongoDB:
   - `checkPrayerTimes()` - читает users из MongoDB
   - `bot.on('location')` - сохраняет в MongoDB (legacy support)

### Frontend

1. **mubarak-way/src/services/api.js** - Обновленные методы:
   - `authAPI.saveLocation()` - использует POST /api/location
   - `authAPI.getLocation()` - новый метод для получения локации
2. **mubarak-way/src/components/LocationRequest.jsx** - использует новый API

---

## Преимущества новой системы

### ✅ Работает всегда
- Не зависит от Telegram location API
- Браузерная геолокация работает надежнее

### ✅ Единый источник данных
- MongoDB - single source of truth
- Нет рассинхронизации между ботом и приложением

### ✅ Персистентность
- Локация сохраняется между сессиями
- Не нужно повторно делиться при каждом входе

### ✅ Автоматический timezone
- Не нужно вручную выбирать часовой пояс
- Определяется автоматически по координатам

### ✅ Обратная совместимость
- Legacy система (subscriptions.json) продолжает работать
- Поддержка отправки локации через Telegram чат (хотя не рекомендуется)

---

## Тестирование

### Локальное тестирование

1. Запустить backend:
   ```bash
   cd server
   npm start
   ```

2. Запустить frontend:
   ```bash
   cd mubarak-way
   npm run dev
   ```

3. Открыть http://localhost:5173
4. Перейти на страницу Prayer Times или Qibla
5. Нажать "Разрешить доступ" к геолокации
6. Проверить в консоли:
   ```
   📍 Saving location to database: { telegramId, latitude, longitude }
   ✅ Location saved successfully: { success: true, data: {...} }
   ```

7. Проверить в MongoDB:
   ```javascript
   db.users.findOne({ telegramId: "123456789" })
   ```

8. Проверить в боте:
   ```
   /prayer
   ```

### Production тестирование

После деплоя на Render.com:

1. Открыть бота в Telegram
2. Нажать "🌐 Открыть приложение"
3. Перейти на Prayer Times
4. Разрешить геолокацию
5. Вернуться в чат с ботом
6. Отправить `/prayer`
7. Убедиться что координаты и время корректны

---

## Troubleshooting

### Проблема: Локация не сохраняется

**Решение:**
1. Проверить логи backend:
   ```bash
   # На Render.com
   Dashboard → Service → Logs
   ```
2. Убедиться что MongoDB подключена:
   ```
   ✅ MongoDB connected successfully
   ```
3. Проверить права доступа к геолокации в браузере

### Проблема: Бот показывает старую локацию

**Решение:**
1. Отправить локацию заново в веб-приложении
2. Подождать 1-2 минуты (кеш обновляется)
3. Проверить `/prayer` снова

### Проблема: Неправильный timezone

**Решение:**
1. Проверить координаты в базе:
   ```javascript
   db.users.findOne({ telegramId: "..." })
   ```
2. Проверить логику `getTimezoneFromCoordinates()` в:
   - `server/routes/location.js`
   - `server/bot.js`

---

## Миграция для существующих пользователей

Пользователи, которые уже используют бота:

1. Откроют веб-приложение
2. Поделятся локацией заново
3. Локация обновится в MongoDB
4. Старые данные из `subscriptions.json` перезапишутся

**Автоматическая синхронизация:**
- `checkPrayerTimes()` автоматически синхронизирует MongoDB → subscriptions.json
- Обратная совместимость с legacy системой сохранена

---

## Резюме

🎉 **Готово!** Теперь геолокация работает через веб-приложение:

- ✅ Пользователь делится локацией в web app
- ✅ Сохраняется в MongoDB с автоопределением timezone
- ✅ Бот читает из MongoDB для уведомлений
- ✅ Корректное время молитв в чате бота
- ✅ Синхронизация между web app и bot

**Рекомендация пользователям:**
> Используйте веб-приложение для настройки геолокации вместо отправки координат в Telegram чат. Это надежнее и удобнее!
